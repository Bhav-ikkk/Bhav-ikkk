<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Commit Destroyer | Bhavik Joshi</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üéØ</text></svg>">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: #010409;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', -apple-system, sans-serif;
            overflow: hidden;
        }

        .game-container {
            position: relative;
            max-width: 900px;
            width: 100%;
            padding: 0 16px;
        }

        #gameCanvas {
            border-radius: 12px;
            background: #0d1117;
            border: 1px solid #21262d;
            display: block;
            max-width: 100%;
            height: auto;
            touch-action: none; /* Prevent default touch behaviors */
        }

        /* Mobile responsive styles */
        @media (max-width: 768px) {
            .game-container {
                padding: 0 8px;
            }
            
            #gameCanvas {
                border-radius: 8px;
            }
            
            .overlay-title {
                font-size: 28px;
            }
            
            .overlay-subtitle {
                font-size: 14px;
            }
            
            .menu-btn {
                font-size: 14px;
                padding: 12px 32px;
            }
            
            .upgrade-grid {
                grid-template-columns: repeat(2, 1fr);
                max-width: 300px;
            }
            
            .stats-display {
                gap: 16px;
                flex-wrap: wrap;
            }
            
            .controls-hint {
                display: none; /* Hide controls hint on mobile to prevent blocking */
            }
        }
        
        @media (max-width: 480px) {
            .overlay-title {
                font-size: 24px;
            }
            
            .menu-btn {
                font-size: 13px;
                padding: 10px 24px;
            }
            
            .upgrade-grid {
                gap: 8px;
            }
            
            .stat-box-value {
                font-size: 22px;
            }
        }

        /* Overlay screens */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(1, 4, 9, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            z-index: 10;
            backdrop-filter: blur(8px);
        }

        .overlay.hidden { display: none; }

        .overlay-title {
            font-size: 42px;
            font-weight: 700;
            color: #e6edf3;
            margin-bottom: 8px;
        }

        .overlay-subtitle {
            font-size: 16px;
            color: #7d8590;
            margin-bottom: 32px;
        }

        .menu-btn {
            background: linear-gradient(135deg, #238636 0%, #2ea043 100%);
            border: none;
            color: #fff;
            font-family: 'Inter', sans-serif;
            font-size: 15px;
            font-weight: 600;
            padding: 14px 48px;
            border-radius: 8px;
            cursor: pointer;
            margin: 6px;
            transition: all 0.2s;
        }

        .menu-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(46, 160, 67, 0.4);
        }

        .menu-btn.secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }

        .menu-btn.secondary:hover {
            background: #30363d;
            box-shadow: none;
        }

        .stats-display {
            display: flex;
            gap: 32px;
            margin: 24px 0;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 28px;
            font-weight: 700;
            color: #58a6ff;
        }

        .stat-box-label {
            font-size: 11px;
            color: #484f58;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .level-badge {
            background: linear-gradient(135deg, #a371f7 0%, #8957e5 100%);
            color: #fff;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .upgrade-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin: 20px 0;
            max-width: 400px;
        }

        .upgrade-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upgrade-card:hover {
            border-color: #58a6ff;
            transform: translateY(-2px);
        }

        .upgrade-card.selected {
            border-color: #58a6ff;
            background: #1c2128;
        }

        .upgrade-card.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .upgrade-icon { font-size: 24px; margin-bottom: 8px; }
        .upgrade-name { font-size: 12px; color: #e6edf3; font-weight: 600; }
        .upgrade-desc { font-size: 10px; color: #7d8590; margin-top: 4px; }
        .upgrade-cost { font-size: 11px; color: #f78166; margin-top: 6px; font-weight: 600; }

        .lives-display {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
        }

        .life-icon {
            font-size: 20px;
            filter: drop-shadow(0 0 4px rgba(248, 81, 73, 0.5));
        }

        .life-icon.lost { opacity: 0.2; filter: none; }

        .high-score {
            font-size: 12px;
            color: #7d8590;
            margin-top: 16px;
        }

        .high-score span {
            color: #f0883e;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
        }

        .controls-hint {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            color: #484f58;
            display: flex;
            gap: 16px;
            pointer-events: none; /* Don't block clicks on mobile */
        }

        .key-hint {
            background: rgba(33, 38, 45, 0.8);
            padding: 4px 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
        }

        .github-credit {
            position: absolute;
            bottom: -32px;
            width: 100%;
            text-align: center;
            font-size: 11px;
            color: #484f58;
        }

        .github-credit a {
            color: #58a6ff;
            text-decoration: none;
        }

        .github-credit a:hover { text-decoration: underline; }

        /* Sound toggle */
        .sound-toggle {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(33, 38, 45, 0.9);
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            z-index: 5;
            transition: all 0.2s;
        }

        .sound-toggle:hover { background: #30363d; }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="900" height="520"></canvas>
        
        <button class="sound-toggle" id="soundToggle">üîä</button>

        <!-- Start Screen -->
        <div class="overlay" id="startScreen">
            <div class="overlay-title">Commit Destroyer</div>
            <div class="overlay-subtitle">Destroy GitHub contributions to score points</div>
            <div style="display: flex; gap: 24px; margin: 20px 0;">
                <div style="text-align: center;">
                    <div style="font-size: 32px;">üéØ</div>
                    <div style="font-size: 11px; color: #7d8590; margin-top: 4px;">Aim & Shoot</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px;">‚ö°</div>
                    <div style="font-size: 11px; color: #7d8590; margin-top: 4px;">Collect Power-ups</div>
                </div>
                <div style="text-align: center;">
                    <div style="font-size: 32px;">üèÜ</div>
                    <div style="font-size: 11px; color: #7d8590; margin-top: 4px;">Beat High Score</div>
                </div>
            </div>
            <button class="menu-btn" id="startBtn">Start Game</button>
            <div class="high-score">High Score: <span id="highScoreDisplay">0</span></div>
            <div class="controls-hint">
                <span><span class="key-hint">Mouse</span> Aim</span>
                <span><span class="key-hint">Click</span> Fire</span>
                <span><span class="key-hint">ESC</span> Pause</span>
            </div>
        </div>

        <!-- Level Complete Screen -->
        <div class="overlay hidden" id="levelScreen">
            <div class="level-badge" id="levelBadge">LEVEL 1 COMPLETE</div>
            <div class="overlay-title" id="levelTitle">Great Job!</div>
            <div class="stats-display">
                <div class="stat-box">
                    <div class="stat-box-value" id="levelScore">0</div>
                    <div class="stat-box-label">Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="levelCombo">x1</div>
                    <div class="stat-box-label">Max Combo</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="levelAccuracy">0%</div>
                    <div class="stat-box-label">Accuracy</div>
                </div>
            </div>
            <div style="font-size: 13px; color: #7d8590; margin-bottom: 8px;">Choose an upgrade:</div>
            <div class="upgrade-grid" id="upgradeGrid"></div>
            <button class="menu-btn" id="nextLevelBtn">Next Level ‚Üí</button>
        </div>

        <!-- Game Over Screen -->
        <div class="overlay hidden" id="gameOverScreen">
            <div class="overlay-title">Game Over</div>
            <div class="lives-display" id="livesLost"></div>
            <div class="stats-display">
                <div class="stat-box">
                    <div class="stat-box-value" id="finalScore">0</div>
                    <div class="stat-box-label">Final Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="finalLevel">1</div>
                    <div class="stat-box-label">Level Reached</div>
                </div>
            </div>
            <div id="newHighScore" style="color: #f0883e; font-weight: 600; margin-bottom: 16px; display: none;">üèÜ New High Score!</div>
            <div>
                <button class="menu-btn" id="retryBtn">Try Again</button>
                <button class="menu-btn secondary" id="menuBtn">Main Menu</button>
            </div>
        </div>

        <!-- Pause Screen -->
        <div class="overlay hidden" id="pauseScreen">
            <div class="overlay-title">Paused</div>
            <div class="stats-display">
                <div class="stat-box">
                    <div class="stat-box-value" id="pauseScore">0</div>
                    <div class="stat-box-label">Score</div>
                </div>
                <div class="stat-box">
                    <div class="stat-box-value" id="pauseLevel">1</div>
                    <div class="stat-box-label">Level</div>
                </div>
            </div>
            <button class="menu-btn" id="resumeBtn">Resume</button>
            <button class="menu-btn secondary" id="quitBtn">Quit to Menu</button>
        </div>

        <div class="github-credit">
            Made by <a href="https://github.com/Bhav-ikkk" target="_blank">@Bhav-ikkk</a> ‚Ä¢ Destroy my commits!
        </div>
    </div>

    <script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const W = canvas.width, H = canvas.height;

    // Audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let audioCtx;
    let soundEnabled = true;

    function initAudio() {
        if (!audioCtx) audioCtx = new AudioCtx();
    }

    function playSound(freq, type = 'sine', duration = 0.1, vol = 0.08) {
        if (!soundEnabled || !audioCtx) return;
        try {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        } catch(e) {}
    }

    function playMelody(notes) {
        notes.forEach(([freq, delay], i) => {
            setTimeout(() => playSound(freq, 'sine', 0.2, 0.06), delay);
        });
    }

    // Game State
    const game = {
        state: 'menu', // menu, playing, paused, levelComplete, gameOver
        level: 1,
        score: 0,
        lives: 3,
        maxCombo: 1,
        combo: 1,
        comboTimer: 0,
        totalShots: 0,
        totalHits: 0,
        
        // Player
        player: { x: W/2, y: H - 50, baseSpeed: 0.12 },
        mouseX: W/2,
        shooting: false,
        lastShot: 0,
        
        // Entities
        bullets: [],
        blocks: [],
        particles: [],
        powerups: [],
        enemies: [],
        
        // Upgrades
        fireRate: 1,
        bulletSpeed: 1,
        bulletDamage: 1,
        multiShot: 1,
        piercing: false,
        shield: false,
        
        // Temp powerups
        rapidFire: 0,
        tempMulti: 0,
        tempPierce: 0,
        
        screenShake: 0,
    };

    const COLORS = ['#161b22', '#0e4429', '#006d32', '#26a641', '#39d353'];
    
    // Level configurations
    const LEVELS = [
        { name: "Warm Up", pattern: 'random', density: 0.6, hasEnemies: false },
        { name: "Getting Serious", pattern: 'random', density: 0.7, hasEnemies: false },
        { name: "Full Grid", pattern: 'full', density: 0.8, hasEnemies: false },
        { name: "The Wall", pattern: 'wall', density: 0.9, hasEnemies: false },
        { name: "Invaders", pattern: 'random', density: 0.6, hasEnemies: true, enemyCount: 2 },
        { name: "Dense Core", pattern: 'center', density: 0.85, hasEnemies: false },
        { name: "Chaos", pattern: 'random', density: 0.75, hasEnemies: true, enemyCount: 3 },
        { name: "Final Push", pattern: 'full', density: 0.9, hasEnemies: true, enemyCount: 4 },
        { name: "Endless", pattern: 'random', density: 0.8, hasEnemies: true, enemyCount: 5, endless: true },
    ];

    const UPGRADES = [
        { id: 'fireRate', icon: 'üî•', name: 'Fire Rate', desc: '+25% speed', cost: 0, apply: () => game.fireRate *= 1.25 },
        { id: 'damage', icon: 'üí•', name: 'Damage', desc: '+1 damage', cost: 0, apply: () => game.bulletDamage += 1 },
        { id: 'speed', icon: '‚ö°', name: 'Bullet Speed', desc: '+20% speed', cost: 0, apply: () => game.bulletSpeed *= 1.2 },
        { id: 'multi', icon: 'üî±', name: 'Multi Shot', desc: '+1 bullet', cost: 0, apply: () => game.multiShot = Math.min(game.multiShot + 1, 5) },
        { id: 'pierce', icon: 'üíé', name: 'Piercing', desc: 'Bullets pierce', cost: 0, apply: () => game.piercing = true },
        { id: 'life', icon: '‚ù§Ô∏è', name: 'Extra Life', desc: '+1 life', cost: 0, apply: () => game.lives = Math.min(game.lives + 1, 5) },
    ];

    // High score
    let highScore = parseInt(localStorage.getItem('commitDestroyer_highScore') || '0');
    document.getElementById('highScoreDisplay').textContent = highScore.toLocaleString();

    // Helpers
    function lerp(a, b, t) { return a + (b - a) * t; }
    function rand(min, max) { return Math.random() * (max - min) + min; }
    function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }

    // Initialize level blocks
    function initLevel() {
        game.blocks = [];
        game.enemies = [];
        game.bullets = [];
        game.particles = [];
        game.powerups = [];
        game.combo = 1;
        game.comboTimer = 0;
        
        const levelConfig = LEVELS[Math.min(game.level - 1, LEVELS.length - 1)];
        const blockW = 14, blockH = 14, gap = 3;
        const cols = 52, rows = 7;
        const startX = (W - cols * (blockW + gap)) / 2;
        const startY = 60;

        for (let col = 0; col < cols; col++) {
            for (let row = 0; row < rows; row++) {
                let shouldPlace = false;
                
                switch(levelConfig.pattern) {
                    case 'full':
                        shouldPlace = Math.random() < levelConfig.density;
                        break;
                    case 'wall':
                        shouldPlace = row < 5 && Math.random() < levelConfig.density;
                        break;
                    case 'center':
                        const centerDist = Math.abs(col - cols/2) / (cols/2);
                        shouldPlace = Math.random() < (1 - centerDist) * levelConfig.density;
                        break;
                    default:
                        shouldPlace = Math.random() < levelConfig.density * 0.75;
                }
                
                if (!shouldPlace) continue;

                const r = Math.random();
                let level = r < 0.3 ? 1 : r < 0.55 ? 2 : r < 0.8 ? 3 : 4;
                // Higher levels have stronger blocks
                if (game.level > 3 && Math.random() < 0.3) level = Math.min(level + 1, 4);

                game.blocks.push({
                    x: startX + col * (blockW + gap),
                    y: startY + row * (blockH + gap),
                    w: blockW, h: blockH,
                    hits: level,
                    maxHits: level,
                    level: level,
                    flash: 0
                });
            }
        }

        // Add enemies for later levels
        if (levelConfig.hasEnemies) {
            for (let i = 0; i < levelConfig.enemyCount; i++) {
                spawnEnemy();
            }
        }
    }

    function spawnEnemy() {
        game.enemies.push({
            x: rand(100, W - 100),
            y: rand(200, 280),
            vx: rand(-1, 1),
            vy: 0,
            w: 30, h: 20,
            health: 3 + Math.floor(game.level / 2),
            maxHealth: 3 + Math.floor(game.level / 2),
            shootTimer: rand(60, 120),
            flash: 0
        });
    }

    // Particles
    function explode(x, y, color, count = 10) {
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * 2 / count) * i + rand(-0.3, 0.3);
            const speed = rand(2, 5);
            game.particles.push({
                x, y,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                life: rand(20, 40),
                maxLife: 40,
                color,
                size: rand(2, 4)
            });
        }
    }

    function spawnPowerup(x, y) {
        if (Math.random() > 0.1) return;
        const types = ['rapid', 'multi', 'pierce', 'heal'];
        game.powerups.push({
            x, y,
            type: types[Math.floor(Math.random() * types.length)],
            vy: 1.2,
            pulse: 0
        });
    }

    // Combat
    function fire() {
        const now = Date.now();
        const cooldown = (120 / game.fireRate) / (game.rapidFire > 0 ? 2 : 1);
        if (now - game.lastShot < cooldown) return;
        game.lastShot = now;
        game.totalShots++;

        const bulletCount = game.multiShot + (game.tempMulti > 0 ? 2 : 0);
        const spread = bulletCount > 1 ? 0.12 : 0;

        for (let i = 0; i < bulletCount; i++) {
            const offset = (i - (bulletCount - 1) / 2) * spread;
            const speed = 12 * game.bulletSpeed;
            game.bullets.push({
                x: game.player.x,
                y: game.player.y - 15,
                vx: Math.sin(offset) * speed,
                vy: -Math.cos(offset) * speed,
                damage: game.bulletDamage,
                pierce: game.piercing || game.tempPierce > 0,
                trail: []
            });
        }
        playSound(600 + bulletCount * 100, 'square', 0.06, 0.05);
    }

    function damagePlayer() {
        if (game.shield) {
            game.shield = false;
            explode(game.player.x, game.player.y, '#58a6ff', 20);
            playSound(200, 'sawtooth', 0.3);
            return;
        }
        
        game.lives--;
        game.screenShake = 15;
        explode(game.player.x, game.player.y, '#f85149', 30);
        playSound(150, 'sawtooth', 0.4);
        
        if (game.lives <= 0) {
            gameOver();
        }
    }

    // Game state transitions
    function startGame() {
        game.state = 'playing';
        game.level = 1;
        game.score = 0;
        game.lives = 3;
        game.maxCombo = 1;
        game.totalShots = 0;
        game.totalHits = 0;
        game.fireRate = 1;
        game.bulletSpeed = 1;
        game.bulletDamage = 1;
        game.multiShot = 1;
        game.piercing = false;
        game.shield = false;
        initLevel();
        hideAllScreens();
        playMelody([[523, 0], [659, 100], [784, 200]]);
    }

    function levelComplete() {
        game.state = 'levelComplete';
        game.score += game.level * 500;
        
        // Update high score
        if (game.score > highScore) {
            highScore = game.score;
            localStorage.setItem('commitDestroyer_highScore', highScore);
        }

        document.getElementById('levelBadge').textContent = `LEVEL ${game.level} COMPLETE`;
        document.getElementById('levelTitle').textContent = LEVELS[Math.min(game.level - 1, LEVELS.length - 1)].name;
        document.getElementById('levelScore').textContent = game.score.toLocaleString();
        document.getElementById('levelCombo').textContent = 'x' + game.maxCombo;
        document.getElementById('levelAccuracy').textContent = game.totalShots > 0 
            ? Math.round(game.totalHits / game.totalShots * 100) + '%' 
            : '100%';

        // Generate upgrade options
        const grid = document.getElementById('upgradeGrid');
        grid.innerHTML = '';
        const available = UPGRADES.filter(u => {
            if (u.id === 'pierce' && game.piercing) return false;
            if (u.id === 'life' && game.lives >= 5) return false;
            if (u.id === 'multi' && game.multiShot >= 5) return false;
            return true;
        });
        
        const options = [];
        while (options.length < 3 && available.length > 0) {
            const idx = Math.floor(Math.random() * available.length);
            options.push(available.splice(idx, 1)[0]);
        }

        let selected = null;
        options.forEach(upg => {
            const card = document.createElement('div');
            card.className = 'upgrade-card';
            card.innerHTML = `
                <div class="upgrade-icon">${upg.icon}</div>
                <div class="upgrade-name">${upg.name}</div>
                <div class="upgrade-desc">${upg.desc}</div>
            `;
            card.onclick = () => {
                grid.querySelectorAll('.upgrade-card').forEach(c => c.classList.remove('selected'));
                card.classList.add('selected');
                selected = upg;
                playSound(400, 'sine', 0.1);
            };
            grid.appendChild(card);
        });

        document.getElementById('nextLevelBtn').onclick = () => {
            if (selected) selected.apply();
            game.level++;
            game.state = 'playing';
            initLevel();
            hideAllScreens();
            playSound(523, 'sine', 0.15);
        };

        showScreen('levelScreen');
        playMelody([[523, 0], [659, 150], [784, 300], [1047, 450]]);
    }

    function gameOver() {
        game.state = 'gameOver';
        
        const isNewHigh = game.score > highScore;
        if (isNewHigh) {
            highScore = game.score;
            localStorage.setItem('commitDestroyer_highScore', highScore);
            document.getElementById('highScoreDisplay').textContent = highScore.toLocaleString();
        }

        document.getElementById('finalScore').textContent = game.score.toLocaleString();
        document.getElementById('finalLevel').textContent = game.level;
        document.getElementById('newHighScore').style.display = isNewHigh ? 'block' : 'none';

        const livesEl = document.getElementById('livesLost');
        livesEl.innerHTML = '';
        for (let i = 0; i < 3; i++) {
            const icon = document.createElement('span');
            icon.className = 'life-icon lost';
            icon.textContent = 'üíî';
            livesEl.appendChild(icon);
        }

        showScreen('gameOverScreen');
        playSound(200, 'sawtooth', 0.5);
    }

    function hideAllScreens() {
        document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
    }

    function showScreen(id) {
        hideAllScreens();
        document.getElementById(id).classList.remove('hidden');
    }

    // Update
    function update() {
        if (game.state !== 'playing') return;

        // Player movement
        game.player.x = lerp(game.player.x, game.mouseX, game.player.baseSpeed);
        game.player.x = Math.max(30, Math.min(W - 30, game.player.x));

        // Shooting
        if (game.shooting) fire();

        // Timers
        if (game.comboTimer > 0) {
            game.comboTimer--;
            if (game.comboTimer <= 0) game.combo = 1;
        }
        if (game.rapidFire > 0) game.rapidFire--;
        if (game.tempMulti > 0) game.tempMulti--;
        if (game.tempPierce > 0) game.tempPierce--;
        game.screenShake *= 0.9;

        // Bullets
        for (let i = game.bullets.length - 1; i >= 0; i--) {
            const b = game.bullets[i];
            b.trail.push({x: b.x, y: b.y});
            if (b.trail.length > 5) b.trail.shift();
            
            b.x += b.vx;
            b.y += b.vy;

            if (b.y < -20 || b.x < -20 || b.x > W + 20) {
                game.bullets.splice(i, 1);
                continue;
            }

            // Hit blocks
            let hitBlock = false;
            for (let j = game.blocks.length - 1; j >= 0; j--) {
                const block = game.blocks[j];
                if (b.x > block.x && b.x < block.x + block.w &&
                    b.y > block.y && b.y < block.y + block.h) {
                    
                    block.hits -= b.damage;
                    block.flash = 6;
                    game.totalHits++;
                    game.comboTimer = 90;
                    
                    explode(b.x, b.y, COLORS[block.level], 5);
                    
                    if (block.hits <= 0) {
                        const points = block.maxHits * 10 * game.combo;
                        game.score += points;
                        game.combo = Math.min(game.combo + 1, 32);
                        game.maxCombo = Math.max(game.maxCombo, game.combo);
                        explode(block.x + block.w/2, block.y + block.h/2, COLORS[block.level], 12);
                        spawnPowerup(block.x + block.w/2, block.y + block.h/2);
                        game.blocks.splice(j, 1);
                        game.screenShake = Math.min(game.screenShake + 2, 8);
                        playSound(300 + block.level * 150, 'sine', 0.12);
                    } else {
                        playSound(200, 'square', 0.05);
                    }

                    if (!b.pierce) hitBlock = true;
                    break;
                }
            }

            // Hit enemies
            if (!hitBlock) {
                for (let j = game.enemies.length - 1; j >= 0; j--) {
                    const e = game.enemies[j];
                    if (b.x > e.x - e.w/2 && b.x < e.x + e.w/2 &&
                        b.y > e.y - e.h/2 && b.y < e.y + e.h/2) {
                        
                        e.health -= b.damage;
                        e.flash = 6;
                        game.totalHits++;
                        explode(b.x, b.y, '#f85149', 6);
                        
                        if (e.health <= 0) {
                            game.score += 200 * game.combo;
                            explode(e.x, e.y, '#f85149', 20);
                            game.enemies.splice(j, 1);
                            game.screenShake = 10;
                            playSound(150, 'sawtooth', 0.2);
                        } else {
                            playSound(300, 'square', 0.08);
                        }

                        if (!b.pierce) hitBlock = true;
                        break;
                    }
                }
            }

            if (hitBlock) game.bullets.splice(i, 1);
        }

        // Enemies
        game.enemies.forEach(e => {
            e.x += e.vx;
            if (e.x < 50 || e.x > W - 50) e.vx *= -1;
            e.flash = Math.max(0, e.flash - 1);

            e.shootTimer--;
            if (e.shootTimer <= 0) {
                e.shootTimer = rand(80, 150);
                // Enemy bullet (simplified - goes toward player)
                const angle = Math.atan2(game.player.y - e.y, game.player.x - e.x);
                game.particles.push({
                    x: e.x, y: e.y + 15,
                    vx: Math.cos(angle) * 4,
                    vy: Math.sin(angle) * 4,
                    life: 200,
                    maxLife: 200,
                    color: '#f85149',
                    size: 6,
                    isEnemyBullet: true
                });
                playSound(200, 'square', 0.1, 0.03);
            }
        });

        // Powerups
        for (let i = game.powerups.length - 1; i >= 0; i--) {
            const p = game.powerups[i];
            p.y += p.vy;
            p.pulse += 0.1;

            if (dist(p.x, p.y, game.player.x, game.player.y) < 35) {
                switch(p.type) {
                    case 'rapid': game.rapidFire = 300; break;
                    case 'multi': game.tempMulti = 300; break;
                    case 'pierce': game.tempPierce = 300; break;
                    case 'heal': game.lives = Math.min(game.lives + 1, 5); break;
                }
                explode(p.x, p.y, '#58a6ff', 15);
                game.powerups.splice(i, 1);
                playMelody([[600, 0], [800, 50]]);
                continue;
            }

            if (p.y > H + 20) game.powerups.splice(i, 1);
        }

        // Particles
        for (let i = game.particles.length - 1; i >= 0; i--) {
            const p = game.particles[i];
            p.x += p.vx;
            p.y += p.vy;
            
            if (p.isEnemyBullet) {
                // Check collision with player
                if (dist(p.x, p.y, game.player.x, game.player.y) < 20) {
                    damagePlayer();
                    game.particles.splice(i, 1);
                    continue;
                }
            } else {
                p.vy += 0.1;
            }
            
            p.life--;
            if (p.life <= 0 || p.y > H + 20) game.particles.splice(i, 1);
        }

        // Level complete check
        if (game.blocks.length === 0 && game.enemies.length === 0) {
            levelComplete();
        }
    }

    // Draw
    function draw() {
        ctx.save();
        
        // Screen shake
        if (game.screenShake > 0.5) {
            ctx.translate(
                (Math.random() - 0.5) * game.screenShake * 2,
                (Math.random() - 0.5) * game.screenShake * 2
            );
        }

        // Background
        ctx.fillStyle = '#0d1117';
        ctx.fillRect(0, 0, W, H);

        // Grid
        ctx.strokeStyle = '#161b22';
        ctx.lineWidth = 1;
        for (let x = 0; x < W; x += 50) {
            ctx.beginPath();
            ctx.moveTo(x, 0);
            ctx.lineTo(x, H);
            ctx.stroke();
        }
        for (let y = 0; y < H; y += 50) {
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(W, y);
            ctx.stroke();
        }

        if (game.state === 'playing' || game.state === 'paused') {
            // HUD
            ctx.fillStyle = '#e6edf3';
            ctx.font = '600 13px Inter, sans-serif';
            
            // Score
            ctx.textAlign = 'left';
            ctx.fillStyle = '#484f58';
            ctx.fillText('SCORE', 20, 28);
            ctx.fillStyle = '#58a6ff';
            ctx.font = '700 22px JetBrains Mono, monospace';
            ctx.fillText(game.score.toLocaleString(), 20, 50);

            // Combo
            ctx.fillStyle = '#484f58';
            ctx.font = '600 13px Inter, sans-serif';
            ctx.fillText('COMBO', 140, 28);
            ctx.fillStyle = game.combo > 1 ? '#f78166' : '#484f58';
            ctx.font = '700 22px JetBrains Mono, monospace';
            ctx.fillText('x' + game.combo, 140, 50);
            
            // Combo bar
            ctx.fillStyle = '#21262d';
            ctx.fillRect(140, 54, 60, 3);
            ctx.fillStyle = '#f78166';
            ctx.fillRect(140, 54, 60 * (game.comboTimer / 90), 3);

            // Level
            ctx.textAlign = 'center';
            ctx.fillStyle = '#7d8590';
            ctx.font = '600 12px Inter, sans-serif';
            ctx.fillText('LEVEL ' + game.level, W/2, 28);
            ctx.fillStyle = '#a371f7';
            ctx.font = '500 11px Inter, sans-serif';
            ctx.fillText(LEVELS[Math.min(game.level - 1, LEVELS.length - 1)].name, W/2, 44);

            // Lives
            ctx.textAlign = 'right';
            for (let i = 0; i < 5; i++) {
                ctx.fillStyle = i < game.lives ? '#f85149' : '#21262d';
                ctx.font = '16px sans-serif';
                ctx.fillText('‚ô•', W - 20 - i * 22, 40);
            }

            // Blocks remaining
            ctx.fillStyle = '#484f58';
            ctx.font = '600 11px Inter, sans-serif';
            ctx.fillText(game.blocks.length + ' blocks', W - 20, 55);

            // Active powerups
            let pwY = 75;
            if (game.rapidFire > 0) {
                ctx.fillStyle = 'rgba(247, 129, 102, 0.2)';
                ctx.fillRect(W - 90, pwY, 70, 20);
                ctx.fillStyle = '#f78166';
                ctx.font = '11px Inter';
                ctx.fillText('‚ö° Rapid', W - 55, pwY + 14);
                pwY += 24;
            }
            if (game.tempMulti > 0) {
                ctx.fillStyle = 'rgba(163, 113, 247, 0.2)';
                ctx.fillRect(W - 90, pwY, 70, 20);
                ctx.fillStyle = '#a371f7';
                ctx.fillText('üî± Multi', W - 55, pwY + 14);
                pwY += 24;
            }
            if (game.tempPierce > 0 || game.piercing) {
                ctx.fillStyle = 'rgba(88, 166, 255, 0.2)';
                ctx.fillRect(W - 90, pwY, 70, 20);
                ctx.fillStyle = '#58a6ff';
                ctx.fillText('üíé Pierce', W - 55, pwY + 14);
            }

            // Blocks
            game.blocks.forEach(b => {
                ctx.fillStyle = b.flash > 0 ? '#fff' : COLORS[b.level];
                if (b.flash > 0) b.flash--;
                ctx.beginPath();
                ctx.roundRect(b.x, b.y, b.w, b.h, 2);
                ctx.fill();

                if (b.hits < b.maxHits) {
                    ctx.strokeStyle = `rgba(0,0,0,${(b.maxHits - b.hits) / b.maxHits * 0.6})`;
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(b.x + 2, b.y + 2);
                    ctx.lineTo(b.x + b.w - 2, b.y + b.h - 2);
                    ctx.stroke();
                }

                if (b.hits > 1) {
                    ctx.fillStyle = 'rgba(255,255,255,0.9)';
                    ctx.font = 'bold 8px JetBrains Mono';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(b.hits, b.x + b.w/2, b.y + b.h/2);
                }
            });

            // Enemies
            game.enemies.forEach(e => {
                ctx.fillStyle = e.flash > 0 ? '#fff' : '#f85149';
                ctx.beginPath();
                ctx.moveTo(e.x, e.y - e.h/2);
                ctx.lineTo(e.x + e.w/2, e.y + e.h/2);
                ctx.lineTo(e.x - e.w/2, e.y + e.h/2);
                ctx.closePath();
                ctx.fill();

                // Health bar
                ctx.fillStyle = '#21262d';
                ctx.fillRect(e.x - 15, e.y - e.h/2 - 8, 30, 4);
                ctx.fillStyle = '#f85149';
                ctx.fillRect(e.x - 15, e.y - e.h/2 - 8, 30 * (e.health / e.maxHealth), 4);
            });

            // Powerups
            game.powerups.forEach(p => {
                const size = 14 + Math.sin(p.pulse) * 2;
                ctx.fillStyle = p.type === 'heal' ? '#3fb950' : 
                               p.type === 'rapid' ? '#f78166' : 
                               p.type === 'multi' ? '#a371f7' : '#58a6ff';
                ctx.beginPath();
                ctx.arc(p.x, p.y, size, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#fff';
                ctx.font = '12px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const icon = p.type === 'heal' ? '‚ù§Ô∏è' : p.type === 'rapid' ? '‚ö°' : p.type === 'multi' ? 'üî±' : 'üíé';
                ctx.fillText(icon, p.x, p.y);
            });

            // Bullet trails
            game.bullets.forEach(b => {
                if (b.trail.length > 1) {
                    ctx.strokeStyle = b.pierce ? 'rgba(163, 113, 247, 0.4)' : 'rgba(88, 166, 255, 0.4)';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.beginPath();
                    ctx.moveTo(b.trail[0].x, b.trail[0].y);
                    b.trail.forEach(t => ctx.lineTo(t.x, t.y));
                    ctx.stroke();
                }
            });

            // Bullets
            game.bullets.forEach(b => {
                const grd = ctx.createRadialGradient(b.x, b.y, 0, b.x, b.y, 10);
                const color = b.pierce ? '#a371f7' : '#58a6ff';
                grd.addColorStop(0, color + '66');
                grd.addColorStop(1, color + '00');
                ctx.fillStyle = grd;
                ctx.beginPath();
                ctx.arc(b.x, b.y, 10, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.ellipse(b.x, b.y, 3, 6, Math.atan2(b.vy, b.vx) + Math.PI/2, 0, Math.PI * 2);
                ctx.fill();
            });

            // Particles
            game.particles.forEach(p => {
                ctx.globalAlpha = p.life / p.maxLife;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1;

            // Player
            const px = game.player.x, py = game.player.y;

            // Engine glow
            const engineGrd = ctx.createRadialGradient(px, py + 15, 0, px, py + 15, 25);
            engineGrd.addColorStop(0, 'rgba(247, 129, 102, 0.5)');
            engineGrd.addColorStop(1, 'rgba(247, 129, 102, 0)');
            ctx.fillStyle = engineGrd;
            ctx.beginPath();
            ctx.arc(px, py + 15, 25, 0, Math.PI * 2);
            ctx.fill();

            // Engine flame
            ctx.fillStyle = '#f78166';
            ctx.beginPath();
            ctx.moveTo(px - 6, py + 8);
            ctx.quadraticCurveTo(px, py + 25 + Math.random() * 8, px + 6, py + 8);
            ctx.fill();

            // Ship
            ctx.fillStyle = '#e6edf3';
            ctx.beginPath();
            ctx.moveTo(px, py - 18);
            ctx.lineTo(px + 18, py + 10);
            ctx.lineTo(px + 7, py + 6);
            ctx.lineTo(px, py + 12);
            ctx.lineTo(px - 7, py + 6);
            ctx.lineTo(px - 18, py + 10);
            ctx.closePath();
            ctx.fill();

            // Cockpit
            ctx.fillStyle = '#58a6ff';
            ctx.beginPath();
            ctx.ellipse(px, py - 4, 4, 7, 0, 0, Math.PI * 2);
            ctx.fill();

            // Shield indicator
            if (game.shield) {
                ctx.strokeStyle = 'rgba(88, 166, 255, 0.5)';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(px, py, 28, 0, Math.PI * 2);
                ctx.stroke();
            }

            // Aim line
            ctx.strokeStyle = 'rgba(88, 166, 255, 0.1)';
            ctx.lineWidth = 1;
            ctx.setLineDash([8, 8]);
            ctx.beginPath();
            ctx.moveTo(px, py - 18);
            ctx.lineTo(px, 0);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        ctx.restore();
    }

    // Game loop
    function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
    }

    // Event Listeners
    canvas.addEventListener('mousemove', e => {
        const rect = canvas.getBoundingClientRect();
        game.mouseX = (e.clientX - rect.left) * (W / rect.width);
    });

    canvas.addEventListener('mousedown', e => {
        initAudio();
        if (game.state === 'playing') game.shooting = true;
    });

    canvas.addEventListener('mouseup', () => game.shooting = false);
    canvas.addEventListener('mouseleave', () => game.shooting = false);

    // Touch event listeners for mobile support
    canvas.addEventListener('touchstart', e => {
        e.preventDefault();
        initAudio();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        game.mouseX = (touch.clientX - rect.left) * (W / rect.width);
        if (game.state === 'playing') game.shooting = true;
    });

    canvas.addEventListener('touchmove', e => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const touch = e.touches[0];
        game.mouseX = (touch.clientX - rect.left) * (W / rect.width);
    });

    canvas.addEventListener('touchend', e => {
        e.preventDefault();
        game.shooting = false;
    });

    document.addEventListener('keydown', e => {
        if (e.code === 'Space' && game.state === 'playing') {
            e.preventDefault();
            initAudio();
            game.shooting = true;
        }
        if (e.code === 'Escape') {
            if (game.state === 'playing') {
                game.state = 'paused';
                document.getElementById('pauseScore').textContent = game.score.toLocaleString();
                document.getElementById('pauseLevel').textContent = game.level;
                showScreen('pauseScreen');
            } else if (game.state === 'paused') {
                game.state = 'playing';
                hideAllScreens();
            }
        }
    });

    document.addEventListener('keyup', e => {
        if (e.code === 'Space') game.shooting = false;
    });

    // UI Buttons
    document.getElementById('startBtn').onclick = () => { initAudio(); startGame(); };
    document.getElementById('retryBtn').onclick = () => { startGame(); };
    document.getElementById('menuBtn').onclick = () => { showScreen('startScreen'); };
    document.getElementById('resumeBtn').onclick = () => { game.state = 'playing'; hideAllScreens(); };
    document.getElementById('quitBtn').onclick = () => { game.state = 'menu'; showScreen('startScreen'); };

    document.getElementById('soundToggle').onclick = () => {
        soundEnabled = !soundEnabled;
        document.getElementById('soundToggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    };

    // Start
    gameLoop();
    </script>
</body>
</html>
